<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org"
    xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6">

<head>
    <link type="text/css" rel="stylesheet" href="/css/bootstrap.min.css" th:href="@{/css/bootstrap.min.css}" />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Sell tickets</title>
</head>

<body style="margin:5px">
    <div>
        <h1>Sell tickets</h1>

        <p sec:authorize="isAuthenticated()">
            Kirjautuneena sisään:
            <span sec:authentication="name"></span>
        </p>

        <div th:if="${errorMessage}" th:text="${errorMessage}" class="alert alert-danger"></div>
        <div th:each="event : ${events}">
            <h2>
                Event: <span th:text="${event.name}"></span>,
                Venue: <span th:text="${event.venue.name}"></span>
                Date: <span th:text="${event.date}"></span>
            </h2>
            <div th:each="cost : ${costs}">

                <h4 th:if="${cost.event.eventid == event.eventid}">
                    Type: <span th:text="${cost.type.name}"></span>,
                    Price: <span th:text="${cost.price}"></span>
                    ID: <span th:text="${cost.costid}"></span>
                    <input type="number" th:id="|amount-${cost.costid}" />
                    <button
                        th:onClick="|addTicket(${cost.costid}, document.getElementById('amount-${cost.costid}').value)|">Add</button>
                </h4>
            </div>
        </div>
        <a id="saleLink" class="btn btn-primary" href="">Create Sale</a>
        Test Buttons:
        <a id="saleLink" class="btn btn-primary" href="?tickets=">Empty param</a>
        <a id="saleLink" class="btn btn-primary" href="?tickets=2:5,3:2,1:2">Normal Format</a>
        <a id="saleLink" class="btn btn-primary" href="?tickets=2:5,3:2,1">Missing last</a>
        <a id="saleLink" class="btn btn-primary" href="?tickets=2:5,asdf:2,1:4">ID String</a>
        <a id="saleLink" class="btn btn-primary" href="?tickets=2:5,3:4fdsa,1:3">Quantity String</a>
        <a id="saleLink" class="btn btn-primary" href="?tickets=2:53:2,1:2">Wrong format</a>
        <a id="saleLink" class="btn btn-primary" href="?tickets=2.1:5,3:2,1:10">ID decimal</a>
        <a id="saleLink" class="btn btn-primary" href="?tickets=2:5.5,3:2,1:10">Quantity decimal</a>

        <div id="addStatus"></div>
        <div id="addResult"></div>

        <script>
            let tickets = [];

            function addTicket(id, number) {
                let status = document.getElementById("addStatus");
                let result = document.getElementById("addResult");
                let link = document.getElementById("saleLink");
                let params = "?tickets=";
                status.value= "";
                if (!Number.isInteger(Number(number)) || number <= 0) {
                    status.innerHTML = "Quantity has to be a positive integer"
                    return;
                }
                tickets.push([id, number]);
                tickets.forEach(ticket => {
                    params = `${params}${ticket[0]}:${ticket[1]},`
                })

                status.innerHTML = "";
                result.innerHTML = tickets;
                link.setAttribute("href", params);
            }

        </script>
</body>


</html>